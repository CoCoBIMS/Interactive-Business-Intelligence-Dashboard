<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Churn Sentiment Analyse - Cortina Consult</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <style>
        .status-ok { @apply bg-green-100 text-green-800 border-green-200; }
        .status-achtung { @apply bg-yellow-100 text-yellow-800 border-yellow-200; }
        .status-kritisch { @apply bg-red-100 text-red-800 border-red-200; }
        .phase-onboarding { @apply bg-blue-100 text-blue-800; }
        .phase-aktiv { @apply bg-green-100 text-green-800; }
        .phase-wartung { @apply bg-gray-100 text-gray-800; }
        .phase-ruhend { @apply bg-orange-100 text-orange-800; }
        .risk-bar { @apply h-2 rounded-full; }
        .risk-low { @apply bg-green-500; }
        .risk-medium { @apply bg-yellow-500; }
        .risk-high { @apply bg-red-500; }
        @keyframes pulse-dot { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .pulse-dot { animation: pulse-dot 2s infinite; }
        .tooltip { @apply invisible absolute bg-gray-900 text-white text-xs rounded py-2 px-3 -mt-2 ml-2 w-64 z-50; }
        .has-tooltip:hover .tooltip { @apply visible; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Header -->
    <header class="text-white shadow-lg" style="background: linear-gradient(to right, #6c1428, #4a0e1c);">
        <div class="container mx-auto px-6 py-4">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-bold">Churn Sentiment Analyse</h1>
                    <p class="text-sm" style="color: #f1e8ea;">Kundenabwanderungs-Risiko Dashboard</p>
                </div>
                <div class="text-right">
                    <div class="flex items-center gap-2">
                        <span class="w-2 h-2 bg-green-400 rounded-full pulse-dot"></span>
                        <span id="lastUpdate" class="text-sm">Lädt...</span>
                    </div>
                    <p id="clientCount" class="text-sm" style="color: #f1e8ea;"></p>
                </div>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-6 py-8">
        <!-- Loading indicator -->
        <div id="loading" class="text-center py-12">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 mx-auto" style="border-color: #6c1428;"></div>
            <p class="mt-4 text-gray-600">Daten werden geladen...</p>
        </div>

        <!-- Error message -->
        <div id="error" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-6">
            <strong>Fehler:</strong> <span id="errorMsg"></span>
        </div>

        <!-- Dashboard content -->
        <div id="dashboard" class="hidden">
            <!-- Summary Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-8">
                <div class="bg-white rounded-lg shadow p-4 border-l-4" style="border-color: #6c1428;">
                    <div class="text-sm text-gray-500 uppercase">Kunden Gesamt</div>
                    <div class="text-2xl font-bold" id="totalClients">-</div>
                    <div class="text-xs text-gray-400 mt-1" id="activeVsChurned">-</div>
                </div>
                <div class="bg-white rounded-lg shadow p-4 border-l-4 border-green-500">
                    <div class="text-sm text-gray-500 uppercase">Status OK</div>
                    <div class="text-2xl font-bold text-green-600" id="statusOk">-</div>
                    <div class="text-xs text-gray-400 mt-1">Risiko &lt; 30%</div>
                </div>
                <div class="bg-white rounded-lg shadow p-4 border-l-4 border-yellow-500">
                    <div class="text-sm text-gray-500 uppercase">Achtung</div>
                    <div class="text-2xl font-bold text-yellow-600" id="statusAchtung">-</div>
                    <div class="text-xs text-gray-400 mt-1">Risiko 30-60%</div>
                </div>
                <div class="bg-white rounded-lg shadow p-4 border-l-4 border-red-500">
                    <div class="text-sm text-gray-500 uppercase">Kritisch</div>
                    <div class="text-2xl font-bold text-red-600" id="statusKritisch">-</div>
                    <div class="text-xs text-gray-400 mt-1">Risiko &gt; 60%</div>
                </div>
                <div class="bg-white rounded-lg shadow p-4 border-l-4 border-gray-500">
                    <div class="text-sm text-gray-500 uppercase">Ø Risiko Score</div>
                    <div class="text-2xl font-bold" id="avgRisk">-</div>
                    <div class="text-xs text-gray-400 mt-1">Nur aktive Kunden</div>
                </div>
            </div>

            <!-- Charts Row -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-lg font-semibold mb-4">Risiko-Verteilung</h2>
                    <canvas id="riskChart" height="200"></canvas>
                </div>
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-lg font-semibold mb-4">Kunden nach Phase</h2>
                    <canvas id="phaseChart" height="200"></canvas>
                </div>
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-lg font-semibold mb-4">Datenqualität</h2>
                    <canvas id="qualityChart" height="200"></canvas>
                </div>
            </div>

            <!-- Top Risks Alert -->
            <div class="bg-red-50 border border-red-200 rounded-lg p-6 mb-8" id="topRisksSection">
                <h2 class="text-lg font-semibold text-red-800 mb-4 flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                    </svg>
                    Top 5 Höchste Risiken (Aktive Kunden)
                </h2>
                <div id="topRisks" class="grid gap-4">
                    <!-- Filled by JS -->
                </div>
            </div>

            <!-- Filters -->
            <div class="bg-white rounded-lg shadow p-4 mb-6">
                <div class="flex flex-wrap gap-4 items-center">
                    <div>
                        <label class="text-sm text-gray-600">Suche:</label>
                        <input type="text" id="searchInput" placeholder="Kundenname..."
                               class="ml-2 px-3 py-1 border rounded text-sm w-48">
                    </div>
                    <div>
                        <label class="text-sm text-gray-600">Status:</label>
                        <select id="statusFilter" class="ml-2 px-3 py-1 border rounded text-sm">
                            <option value="">Alle</option>
                            <option value="KRITISCH">Kritisch</option>
                            <option value="ACHTUNG">Achtung</option>
                            <option value="OK">OK</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-sm text-gray-600">Phase:</label>
                        <select id="phaseFilter" class="ml-2 px-3 py-1 border rounded text-sm">
                            <option value="">Alle</option>
                            <option value="ONBOARDING">Onboarding</option>
                            <option value="AKTIV">Aktiv</option>
                            <option value="WARTUNG">Wartung</option>
                            <option value="RUHEND">Ruhend</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-sm text-gray-600">Churned:</label>
                        <select id="churnedFilter" class="ml-2 px-3 py-1 border rounded text-sm">
                            <option value="active">Nur Aktive</option>
                            <option value="churned">Nur Churned</option>
                            <option value="">Alle</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-sm text-gray-600">Jira:</label>
                        <select id="jiraFilter" class="ml-2 px-3 py-1 border rounded text-sm">
                            <option value="jira">Nur Jira-Kunden</option>
                            <option value="">Alle</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-sm text-gray-600">Sortieren:</label>
                        <select id="sortBy" class="ml-2 px-3 py-1 border rounded text-sm">
                            <option value="risk_desc">Risiko (absteigend)</option>
                            <option value="risk_asc">Risiko (aufsteigend)</option>
                            <option value="name">Name (A-Z)</option>
                            <option value="health">Beziehungsgesundheit</option>
                        </select>
                    </div>
                    <div class="ml-auto text-sm text-gray-500">
                        <span id="filteredCount">0</span> Kunden angezeigt
                    </div>
                </div>
            </div>

            <!-- Client Table -->
            <div class="bg-white rounded-lg shadow overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                            <tr>
                                <th class="px-4 py-3">Kunde</th>
                                <th class="px-4 py-3">Status</th>
                                <th class="px-4 py-3">Phase</th>
                                <th class="px-4 py-3 text-center">Risiko</th>
                                <th class="px-4 py-3 text-center">Gesundheit</th>
                                <th class="px-4 py-3">Datenqualität</th>
                                <th class="px-4 py-3">Hauptprobleme</th>
                                <th class="px-4 py-3">Empfehlungen</th>
                            </tr>
                        </thead>
                        <tbody id="clientTable">
                            <!-- Filled by JS -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Pagination/Load More -->
            <div class="text-center mt-6">
                <button id="loadMoreBtn" class="px-6 py-2 text-white rounded" style="background-color: #6c1428;" onmouseover="this.style.backgroundColor='#4a0e1c'" onmouseout="this.style.backgroundColor='#6c1428'">
                    Mehr laden
                </button>
            </div>
        </div>
    </main>

    <!-- Detail Modal -->
    <div id="detailModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-3xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6" id="modalContent">
                <!-- Filled by JS -->
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="py-4 mt-8" style="background-color: #6c1428; color: #f1e8ea;">
        <div class="container mx-auto px-6 text-center text-sm">
            <p>Auto-Refresh alle 60 Minuten | Datenquelle: Churn Sentiment Analyse</p>
            <p class="mt-1">Cortina Consult GmbH</p>
        </div>
    </footer>

    <script>
        // Configuration
        const API_URL = 'api.php';  // PHP API for secure data access
        const DATA_FILE = 'churn_sentiment_analysis.csv';
        const REFRESH_INTERVAL = 60 * 60 * 1000; // 1 hour in ms
        const ITEMS_PER_PAGE = 25;
        const JIRA_BASE_URL = 'https://cocobo.atlassian.net/browse/';

        // State
        let allData = [];
        let filteredData = [];
        let displayedCount = 0;
        let riskChart = null;
        let phaseChart = null;
        let qualityChart = null;

        // Parse CSV
        function parseCSV(text) {
            const result = Papa.parse(text, {
                header: true,
                skipEmptyLines: true,
                dynamicTyping: true
            });
            return result.data;
        }

        // Fetch data via PHP API
        async function fetchData() {
            const response = await fetch(`${API_URL}?file=${encodeURIComponent(DATA_FILE)}`);
            if (!response.ok) {
                throw new Error(`Konnte Daten nicht laden: ${response.status}`);
            }
            const text = await response.text();
            return parseCSV(text);
        }

        // Get status class
        function getStatusClass(status) {
            const s = (status || '').toUpperCase();
            if (s === 'OK') return 'status-ok';
            if (s === 'ACHTUNG') return 'status-achtung';
            if (s === 'KRITISCH') return 'status-kritisch';
            return 'bg-gray-100 text-gray-800';
        }

        // Get phase class
        function getPhaseClass(phase) {
            const p = (phase || '').toUpperCase();
            if (p === 'ONBOARDING') return 'phase-onboarding';
            if (p === 'AKTIV') return 'phase-aktiv';
            if (p === 'WARTUNG') return 'phase-wartung';
            if (p === 'RUHEND') return 'phase-ruhend';
            return 'bg-gray-100 text-gray-800';
        }

        // Get risk bar class
        function getRiskBarClass(risk) {
            if (risk < 30) return 'risk-low';
            if (risk < 60) return 'risk-medium';
            return 'risk-high';
        }

        // Format concerns list
        function formatConcerns(concerns) {
            if (!concerns) return '-';
            const items = concerns.split(' | ').slice(0, 2);
            return items.map(c => `<div class="text-xs truncate max-w-xs" title="${c}">${c}</div>`).join('');
        }

        // Format recommendations
        function formatRecommendations(recs) {
            if (!recs) return '-';
            const items = recs.split(' | ').slice(0, 2);
            return items.map(r => `<div class="text-xs truncate max-w-xs" title="${r}">${r}</div>`).join('');
        }

        // Update summary cards
        function updateSummaryCards() {
            const active = allData.filter(c => c.ist_churned !== true && c.ist_churned !== 'True');
            const churned = allData.filter(c => c.ist_churned === true || c.ist_churned === 'True');

            document.getElementById('totalClients').textContent = allData.length;
            document.getElementById('activeVsChurned').textContent =
                `${active.length} aktiv / ${churned.length} churned`;

            // Status counts (only for active clients)
            const statusOk = active.filter(c => (c.overall_status || '').toUpperCase() === 'OK').length;
            const statusAchtung = active.filter(c => (c.overall_status || '').toUpperCase() === 'ACHTUNG').length;
            const statusKritisch = active.filter(c => (c.overall_status || '').toUpperCase() === 'KRITISCH').length;

            document.getElementById('statusOk').textContent = statusOk;
            document.getElementById('statusAchtung').textContent = statusAchtung;
            document.getElementById('statusKritisch').textContent = statusKritisch;

            // Average risk for active clients
            const avgRisk = active.length > 0
                ? active.reduce((sum, c) => sum + (c.churn_risk_score || 0), 0) / active.length
                : 0;
            document.getElementById('avgRisk').textContent = `${Math.round(avgRisk)}%`;
            document.getElementById('avgRisk').className = `text-2xl font-bold ${
                avgRisk < 30 ? 'text-green-600' : avgRisk < 60 ? 'text-yellow-600' : 'text-red-600'
            }`;
        }

        // Update top risks
        function updateTopRisks() {
            const active = allData.filter(c => c.ist_churned !== true && c.ist_churned !== 'True');
            const topRisks = [...active]
                .sort((a, b) => (b.churn_risk_score || 0) - (a.churn_risk_score || 0))
                .slice(0, 5);

            const container = document.getElementById('topRisks');
            container.innerHTML = topRisks.map(c => `
                <div class="bg-white rounded p-4 border-l-4 ${
                    c.churn_risk_score >= 80 ? 'border-red-500' :
                    c.churn_risk_score >= 60 ? 'border-red-400' : 'border-yellow-400'
                }">
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="font-semibold">${c.client_name || c.epic_schluessel}</div>
                            <a href="${JIRA_BASE_URL}${c.epic_schluessel}" target="_blank"
                               class="text-sm text-blue-600 hover:text-blue-800 hover:underline">
                               ${c.epic_schluessel} ↗
                            </a>
                        </div>
                        <div class="text-2xl font-bold ${
                            c.churn_risk_score >= 80 ? 'text-red-600' :
                            c.churn_risk_score >= 60 ? 'text-red-500' : 'text-yellow-600'
                        }">${c.churn_risk_score}%</div>
                    </div>
                    <div class="mt-2 text-sm text-gray-600">${c.summary_de || '-'}</div>
                    ${c.key_concerns ? `
                        <div class="mt-2 text-xs text-red-700">
                            <strong>Probleme:</strong> ${c.key_concerns.split(' | ').slice(0, 2).join(', ')}
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }

        // Create charts
        function createCharts() {
            const active = allData.filter(c => c.ist_churned !== true && c.ist_churned !== 'True');

            // Risk distribution chart
            const riskBuckets = {
                '0-20%': 0,
                '21-40%': 0,
                '41-60%': 0,
                '61-80%': 0,
                '81-100%': 0
            };
            active.forEach(c => {
                const r = c.churn_risk_score || 0;
                if (r <= 20) riskBuckets['0-20%']++;
                else if (r <= 40) riskBuckets['21-40%']++;
                else if (r <= 60) riskBuckets['41-60%']++;
                else if (r <= 80) riskBuckets['61-80%']++;
                else riskBuckets['81-100%']++;
            });

            const riskCtx = document.getElementById('riskChart').getContext('2d');
            if (riskChart) riskChart.destroy();
            riskChart = new Chart(riskCtx, {
                type: 'bar',
                data: {
                    labels: Object.keys(riskBuckets),
                    datasets: [{
                        data: Object.values(riskBuckets),
                        backgroundColor: ['#10b981', '#84cc16', '#f59e0b', '#f97316', '#ef4444'],
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
                }
            });

            // Phase chart
            const phaseCounts = {};
            active.forEach(c => {
                const p = c.client_phase || 'Unbekannt';
                phaseCounts[p] = (phaseCounts[p] || 0) + 1;
            });

            const phaseCtx = document.getElementById('phaseChart').getContext('2d');
            if (phaseChart) phaseChart.destroy();
            phaseChart = new Chart(phaseCtx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(phaseCounts),
                    datasets: [{
                        data: Object.values(phaseCounts),
                        backgroundColor: ['#3b82f6', '#10b981', '#6b7280', '#f59e0b'],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { position: 'right' } }
                }
            });

            // Data quality chart
            const qualityCounts = { 'high': 0, 'medium': 0, 'low': 0 };
            active.forEach(c => {
                const q = (c.data_quality || 'low').toLowerCase();
                if (qualityCounts[q] !== undefined) qualityCounts[q]++;
            });

            const qualityCtx = document.getElementById('qualityChart').getContext('2d');
            if (qualityChart) qualityChart.destroy();
            qualityChart = new Chart(qualityCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Hoch', 'Mittel', 'Niedrig'],
                    datasets: [{
                        data: [qualityCounts.high, qualityCounts.medium, qualityCounts.low],
                        backgroundColor: ['#10b981', '#f59e0b', '#ef4444'],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { position: 'right' } }
                }
            });
        }

        // Filter and sort data
        function applyFilters() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const status = document.getElementById('statusFilter').value;
            const phase = document.getElementById('phaseFilter').value;
            const churned = document.getElementById('churnedFilter').value;
            const jiraFilter = document.getElementById('jiraFilter').value;
            const sortBy = document.getElementById('sortBy').value;

            filteredData = allData.filter(c => {
                if (search && !(c.client_name || '').toLowerCase().includes(search) &&
                    !(c.epic_schluessel || '').toLowerCase().includes(search)) {
                    return false;
                }
                if (status && (c.overall_status || '').toUpperCase() !== status) {
                    return false;
                }
                if (phase && (c.client_phase || '').toUpperCase() !== phase) {
                    return false;
                }
                if (churned === 'active' && (c.ist_churned === true || c.ist_churned === 'True')) {
                    return false;
                }
                if (churned === 'churned' && c.ist_churned !== true && c.ist_churned !== 'True') {
                    return false;
                }
                // Jira filter - only show clients with Jira data
                if (jiraFilter === 'jira' && (c.has_jira_data !== true && c.has_jira_data !== 'True')) {
                    return false;
                }
                return true;
            });

            // Sort
            filteredData.sort((a, b) => {
                switch(sortBy) {
                    case 'risk_asc': return (a.churn_risk_score || 0) - (b.churn_risk_score || 0);
                    case 'name': return (a.client_name || '').localeCompare(b.client_name || '');
                    case 'health': return (b.relationship_health || 0) - (a.relationship_health || 0);
                    default: return (b.churn_risk_score || 0) - (a.churn_risk_score || 0);
                }
            });

            document.getElementById('filteredCount').textContent = filteredData.length;
            displayedCount = 0;
            document.getElementById('clientTable').innerHTML = '';
            loadMoreRows();
        }

        // Load more rows
        function loadMoreRows() {
            const tbody = document.getElementById('clientTable');
            const nextBatch = filteredData.slice(displayedCount, displayedCount + ITEMS_PER_PAGE);

            nextBatch.forEach(c => {
                const isChurned = c.ist_churned === true || c.ist_churned === 'True';
                const row = document.createElement('tr');
                row.className = `border-b hover:bg-gray-50 cursor-pointer ${isChurned ? 'opacity-60' : ''}`;
                row.onclick = () => showDetail(c);

                row.innerHTML = `
                    <td class="px-4 py-3">
                        <div class="font-medium">${c.client_name || c.epic_schluessel}</div>
                        <div class="text-xs">
                            <a href="${JIRA_BASE_URL}${c.epic_schluessel}" target="_blank"
                               onclick="event.stopPropagation();"
                               class="text-blue-600 hover:text-blue-800 hover:underline">
                               ${c.epic_schluessel}
                            </a>
                            ${(c.has_jira_data === true || c.has_jira_data === 'True') ?
                                '<span class="ml-1 text-green-600" title="Hat Jira-Daten">J</span>' : ''}
                        </div>
                        ${isChurned ? '<span class="text-xs bg-gray-200 text-gray-600 px-2 py-0.5 rounded">Churned</span>' : ''}
                    </td>
                    <td class="px-4 py-3">
                        <span class="px-2 py-1 rounded text-xs font-semibold ${getStatusClass(c.overall_status)}">
                            ${c.overall_status || '-'}
                        </span>
                    </td>
                    <td class="px-4 py-3">
                        <span class="px-2 py-1 rounded text-xs ${getPhaseClass(c.client_phase)}">
                            ${c.client_phase || '-'}
                        </span>
                    </td>
                    <td class="px-4 py-3 text-center">
                        <div class="font-bold ${
                            c.churn_risk_score >= 60 ? 'text-red-600' :
                            c.churn_risk_score >= 30 ? 'text-yellow-600' : 'text-green-600'
                        }">${c.churn_risk_score || 0}%</div>
                        <div class="w-full bg-gray-200 rounded-full h-1.5 mt-1">
                            <div class="h-1.5 rounded-full ${getRiskBarClass(c.churn_risk_score)}"
                                 style="width: ${c.churn_risk_score || 0}%"></div>
                        </div>
                    </td>
                    <td class="px-4 py-3 text-center">
                        <span class="${
                            c.relationship_health >= 7 ? 'text-green-600' :
                            c.relationship_health >= 4 ? 'text-yellow-600' : 'text-red-600'
                        } font-semibold">${c.relationship_health || '-'}/10</span>
                    </td>
                    <td class="px-4 py-3">
                        <span class="px-2 py-1 rounded text-xs ${
                            c.data_quality === 'high' ? 'bg-green-100 text-green-800' :
                            c.data_quality === 'medium' ? 'bg-yellow-100 text-yellow-800' :
                            'bg-gray-100 text-gray-800'
                        }">${c.data_quality || '-'}</span>
                    </td>
                    <td class="px-4 py-3">${formatConcerns(c.key_concerns)}</td>
                    <td class="px-4 py-3">${formatRecommendations(c.recommended_actions)}</td>
                `;
                tbody.appendChild(row);
            });

            displayedCount += nextBatch.length;

            // Hide load more if all loaded
            document.getElementById('loadMoreBtn').style.display =
                displayedCount >= filteredData.length ? 'none' : 'inline-block';
        }

        // Show detail modal
        function showDetail(client) {
            const modal = document.getElementById('detailModal');
            const content = document.getElementById('modalContent');

            const isChurned = client.ist_churned === true || client.ist_churned === 'True';

            content.innerHTML = `
                <div class="flex justify-between items-start mb-6">
                    <div>
                        <h2 class="text-xl font-bold">${client.client_name || client.epic_schluessel}</h2>
                        <p>
                            <a href="${JIRA_BASE_URL}${client.epic_schluessel}" target="_blank"
                               class="text-blue-600 hover:text-blue-800 hover:underline">
                               ${client.epic_schluessel} ↗
                            </a>
                        </p>
                        ${isChurned ? '<span class="bg-gray-200 text-gray-700 px-2 py-1 rounded text-sm">Bereits Churned</span>' : ''}
                    </div>
                    <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
                </div>

                <div class="grid grid-cols-4 gap-4 mb-6">
                    <div class="bg-gray-50 p-3 rounded">
                        <div class="text-sm text-gray-500">Risiko Score</div>
                        <div class="text-2xl font-bold ${
                            client.churn_risk_score >= 60 ? 'text-red-600' :
                            client.churn_risk_score >= 30 ? 'text-yellow-600' : 'text-green-600'
                        }">${client.churn_risk_score || 0}%</div>
                    </div>
                    <div class="bg-gray-50 p-3 rounded">
                        <div class="text-sm text-gray-500">Beziehungsgesundheit</div>
                        <div class="text-2xl font-bold">${client.relationship_health || '-'}/10</div>
                    </div>
                    <div class="bg-gray-50 p-3 rounded">
                        <div class="text-sm text-gray-500">Status</div>
                        <div class="mt-1">
                            <span class="px-3 py-1 rounded text-sm font-semibold ${getStatusClass(client.overall_status)}">
                                ${client.overall_status || '-'}
                            </span>
                        </div>
                    </div>
                    <div class="bg-gray-50 p-3 rounded">
                        <div class="text-sm text-gray-500">Phase</div>
                        <div class="mt-1">
                            <span class="px-3 py-1 rounded text-sm ${getPhaseClass(client.client_phase)}">
                                ${client.client_phase || '-'}
                            </span>
                        </div>
                    </div>
                </div>

                <div class="mb-6">
                    <h3 class="font-semibold mb-2">Zusammenfassung</h3>
                    <p class="text-gray-700 bg-gray-50 p-4 rounded">${client.summary_de || 'Keine Zusammenfassung verfügbar.'}</p>
                </div>

                ${client.key_concerns ? `
                <div class="mb-6">
                    <h3 class="font-semibold mb-2 text-red-700">Hauptprobleme</h3>
                    <ul class="list-disc pl-5 space-y-1 text-gray-700">
                        ${client.key_concerns.split(' | ').map(c => `<li>${c}</li>`).join('')}
                    </ul>
                </div>
                ` : ''}

                ${client.recommended_actions ? `
                <div class="mb-6">
                    <h3 class="font-semibold mb-2 text-blue-700">Empfohlene Maßnahmen</h3>
                    <ul class="list-disc pl-5 space-y-1 text-gray-700">
                        ${client.recommended_actions.split(' | ').map(r => `<li>${r}</li>`).join('')}
                    </ul>
                </div>
                ` : ''}

                ${client.kuendigung_kontext && client.kuendigung_kontext !== 'null' ? `
                <div class="mb-6 bg-yellow-50 p-4 rounded border border-yellow-200">
                    <h3 class="font-semibold text-yellow-800 mb-2">Kündigungs-Kontext</h3>
                    <p class="text-gray-700">${client.kuendigung_kontext}</p>
                </div>
                ` : ''}

                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div>
                        <h3 class="font-semibold mb-2">Metriken</h3>
                        <table class="text-sm w-full">
                            <tr class="border-b"><td class="py-1 text-gray-500">Frustration</td><td class="text-right">${client.frustration_level || '-'}/10</td></tr>
                            <tr class="border-b"><td class="py-1 text-gray-500">Ton-Verschlechterung</td><td class="text-right">${client.tone_deterioration || '-'}/10</td></tr>
                            <tr class="border-b"><td class="py-1 text-gray-500">Eskalationssignale</td><td class="text-right">${client.escalation_signals || '-'}/10</td></tr>
                            <tr class="border-b"><td class="py-1 text-gray-500">Positive Signale</td><td class="text-right">${client.positive_signals || '-'}/10</td></tr>
                        </table>
                    </div>
                    <div>
                        <h3 class="font-semibold mb-2">Aktivität</h3>
                        <table class="text-sm w-full">
                            <tr class="border-b"><td class="py-1 text-gray-500">Tage seit letztem Ticket</td><td class="text-right">${client.tage_seit_letztem_ticket || '-'}</td></tr>
                            <tr class="border-b"><td class="py-1 text-gray-500">DPMS Tage inaktiv</td><td class="text-right">${client.dpms_tage_seit_letzter_aktivitaet || '-'}</td></tr>
                            <tr class="border-b"><td class="py-1 text-gray-500">Konversationen</td><td class="text-right">${client.conversation_count || 0}</td></tr>
                            <tr class="border-b"><td class="py-1 text-gray-500">Datenqualität</td><td class="text-right">${client.data_quality || '-'}</td></tr>
                        </table>
                    </div>
                </div>

                <div class="text-xs text-gray-400">
                    Analysiert: ${client.analyzed_at || '-'}
                </div>
            `;

            modal.classList.remove('hidden');
        }

        // Close modal
        function closeModal() {
            document.getElementById('detailModal').classList.add('hidden');
        }

        // Load all data
        async function loadData() {
            try {
                document.getElementById('loading').classList.remove('hidden');
                document.getElementById('dashboard').classList.add('hidden');
                document.getElementById('error').classList.add('hidden');

                allData = await fetchData();

                updateSummaryCards();
                createCharts();
                updateTopRisks();

                // Setup default filters (active only, Jira only)
                document.getElementById('churnedFilter').value = 'active';
                document.getElementById('jiraFilter').value = 'jira';
                applyFilters();

                document.getElementById('lastUpdate').textContent =
                    `Aktualisiert: ${new Date().toLocaleString('de-DE')}`;
                document.getElementById('clientCount').textContent =
                    `${allData.length} Kunden analysiert`;

                document.getElementById('loading').classList.add('hidden');
                document.getElementById('dashboard').classList.remove('hidden');

            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('error').classList.remove('hidden');
                document.getElementById('errorMsg').textContent = error.message;
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            ['searchInput', 'statusFilter', 'phaseFilter', 'churnedFilter', 'jiraFilter', 'sortBy'].forEach(id => {
                document.getElementById(id).addEventListener('change', applyFilters);
                document.getElementById(id).addEventListener('input', applyFilters);
            });

            document.getElementById('loadMoreBtn').addEventListener('click', loadMoreRows);

            // Close modal on outside click
            document.getElementById('detailModal').addEventListener('click', (e) => {
                if (e.target.id === 'detailModal') closeModal();
            });

            // ESC to close modal
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') closeModal();
            });
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            setupEventListeners();
            loadData();

            // Auto-refresh every hour
            setInterval(loadData, REFRESH_INTERVAL);
        });
    </script>
</body>
</html>
